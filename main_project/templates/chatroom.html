<!DOCTYPE html>
<html>
    {% load pwa %}
    {% progressive_web_app_meta %}
    <head> 
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="viewport" content="width=device-width; viewport-fit=cover">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta charset="utf-8">
        <!-- <script src="static/jquery.js"></script> -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <link href="static/chatroom.css" rel="stylesheet">
    </head>
    <body>
        <div class="chatroom-list-page" id="chatroom_list_page" style="display: none">
            <div class="chatroom-list-header">
                <a  id="back_arrow_link">
                    <div class="back_arrow"></div>
                </a>
                
                <img class="icon-chatroom" src="static/src/icon_chatroom.png" class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls1" data-bs-slide="prev">
                <input id="chatroom_search" type="text" placeholder="搜尋" class="search-bar">
                <div class="btn-cancel">取消</div>
            </div>
            <div class="chatroom-list" id="chatroom_list_div">
                <!-- JavaScript append -->
            </div>
            <a id="home_link">
                <div class="quarter_circle" style="left: 0vw; background-image: url('static/src/home.png');"></div>
            </a>
        </div>
            
        <div class="chatroom-record-page" id="chatroom_record_page" style="display: none">
            <div class="chatroom-record-header">
                <!-- JavaScript append -->
            </div>
            <div class="chatroom-record-content" id="chatroom-record-content-ID">
                <!-- JavaScript append -->
            </div>
            <div class="chatroom-record-footer">
                <textarea id="chat-message-input" class="input-msg" placeholder="發送訊息"></textarea>
                <img id="chat-message-submit" class="btn-send" src="static/src/icon_send.png" type="button">
            </div>
        </div>

        <div class="chatroom-member-page" style="display: none">
            <div class="chatroom-member-header">
                <a id="back-to-chatroom-record">
                    <div class="back_arrow" ></div>
                </a>
                
                <!-- <div class="member-title">群組名要可以放十個字</div> -->
                <!-- <img class="edit-member" src="static/src/edit.png" type="button" data-toggle="collapse" data-target=".delete-member"> -->
            </div>
            <div class="chatroom-member-list">
                <!-- <div class="chatroom-member-item">
                    <img class="collapse width delete-member" type="button" src="static/src/delete.png" data-toggle="modal" data-target="#delete-member-modal">
                    <div class="chatroom-member-photo"></div>
                    <div class="chatroom-member-name">嗨嗨嗨是我啦哈哈</div>
                </div>
                <div class="chatroom-member-item">
                    <img class="collapse width delete-member" type="button" src="static/src/delete.png" data-toggle="modal" data-target="#delete-member-modal">
                    <div class="chatroom-member-photo"></div>
                    <div class="chatroom-member-name">嗨嗨嗨是我啦哈哈</div>
                </div>
                <div class="chatroom-member-item">
                    <img class="collapse width delete-member" type="button" src="static/src/delete.png" data-toggle="modal" data-target="#delete-member-modal">
                    <div class="chatroom-member-photo"></div>
                    <div class="chatroom-member-name">嗨嗨嗨是我啦哈哈</div>
                </div> -->
            </div>
        </div>

        <!--Delete Member Modal -->
        <div class="modal fade" id="delete-member-modal" tabindex="-1" aria-hidden="true" data-backdrop="static">
            <div class="modal-dialog">
                <div id="delete_modal" class="modal-content" style='height: 48vw;'>
                    <!-- <div class="modal-body">
                        <div class="modal-body-text-confirm">
                            確定將成員<br>
                            是我啦哈哈<br>
                            從此群組中刪除嗎？
                        </div>                        
                    </div>
                    <button type="button" class="modal-btn-cancel" data-dismiss="modal">取消</button>
                    <button type="button" class="modal-btn-confirm">確認</button>                         -->
                </div>
            </div>
        </div>
    </body>
</html>


<script>
    $.ajaxSetup({
        data:{csrfmiddlewaretoken:'{{ csrf_token }}'}
    })    

    function getCookie(cookieName) {
        var name = cookieName + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i<ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1);
            if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
        }
        return "";
    }

    var timeout_update_chat_list;
    var chatroom_ID;
    var timeout_update_mission_msg;
    var member_ID = "";
    var last_chatroom_list = "1"
    var last_sender_name_len = ""
    window.onload = function(){
        // $('#newpic').html("")
        // document.getElementById('back_arrow_link').href = document.referrer;

        parameter = window.location.href.split('?')
        if(parameter.length == 1){
            parameter[1] = "account=account"
        }

        var check_in = 0
        if(parameter[1].split("&").length == 1){
            if( parameter[1].toString().split("&")[0].split('=')[0] != "account" | parameter[1].toString().split("&")[0].split('=')[1] != getCookie("account")){
                check_in = 1;
            }
        }
        else if(parameter[1].split("&").length == 2) {
            if( parameter[1].toString().split("&")[0].split('=')[0] != "account" | parameter[1].toString().split("&")[1].split('=')[0] != "chatroom_ID"  | parameter[1].toString().split("&")[0].split('=')[1] != getCookie("account")){
                check_in = 1;
            }
        }
        else if(parameter[1].split("&").length == 3) {
            if( parameter[1].toString().split("&")[0].split('=')[0] != "account" | parameter[1].toString().split("&")[1].split('=')[0] != "chatroom_ID" | parameter[1].toString().split("&")[2].split('=')[0] != "check"  | parameter[1].toString().split("&")[0].split('=')[1] != getCookie("account")){
                check_in = 1;
            }
        }

        if( check_in ){
            split_q = parameter;
            split_and = parameter[1].split('&');
            split_and[0] = "account=" + getCookie("account");
            split_and_length = 1
            
            if(split_and.length == 2){
                split_and[1] = "chatroom_ID=" + parameter[1].split('&')[1].split('=')[1];
                split_and_length = 2;
            }
            else if(split_and.length >= 3){
                split_and[1] = "chatroom_ID=" + parameter[1].split('&')[1].split('=')[1];
                split_and[2] = "check";
                split_and_length = 3
            }
            
            loc = split_q[0] + "?"
            for(var i=0; i < split_and_length; i++){
                if (i == split_and_length-1){
                    loc = loc + split_and[i]
                }
                else{
                    loc = loc + split_and[i] + "&"
                }
            }
            window.location.href = loc
        }
        else{
            document.getElementById('back_arrow_link').href = "/main?account=" + window.location.href.split('?')[1].split('&')[0].split('=')[1];
            document.getElementById('home_link').href = "/main?account=" + window.location.href.split('?')[1].split('&')[0].split('=')[1];
            
            parameter = window.location.href.split('?')[1].split('&')
            if(parameter.length == 1){
                $('#chatroom_list_page').show();
                update_chat_list();
                timeout_update_chat_list = window.setInterval( update_chat_list , 1000)
            }
            else if(parameter.length == 2){
                chatroom_ID = parameter[1].split('=')[1];
                $.ajax({
                    url: '/check_chatroom',
                    method: 'POST',
                    type: 'POST',
                    dataType: "json",
                    data: {
                        "chatroom_ID": chatroom_ID,
                    },
                    success: function (data) {
                        if (data.result == "success"){
                            $('#chatroom_record_page').show();
                            update_mission_msg( chatroom_ID, "first" );
                            timeout_update_mission_msg = window.setInterval( ( ()=>update_mission_msg(chatroom_ID) ) , 500);
                        }
                        else{
                            window.location.href = window.location.href.split("&")[0]
                        }
                    }
                });
            }
            else if(parameter.length == 3){
                chatroom_ID = parameter[1].split('=')[1];

                $.ajax({
                    url: '/check_chatroom',
                    method: 'POST',
                    type: 'POST',
                    dataType: "json",
                    data: {
                        "chatroom_ID": chatroom_ID,
                    },
                    success: function (data) {
                        if (data.result == "success"){
                            $('.chatroom-member-page').show();
                            $("#back-to-chatroom-record").attr("href", "/chatroom?"+parameter[0]+"&"+parameter[1])
                            group_member();
                        }
                        else{
                            window.location.href = window.location.href.split("&")[0]
                        }
                    }
                });

                
                // update_mission_msg( chatroom_ID, "first" );
                // timeout_update_mission_msg = window.setInterval( ( ()=>update_mission_msg(chatroom_ID) ) , 500);
            }
        }
    }
    
    function group_member(){
        window.clearInterval(timeout_update_mission_msg);        
        
        $.ajax({
            url: '/get_mission_chatroom_member',
            method: 'POST',
            type: 'POST',
            dataType: "json",
            data: {
                "chatroom_ID": window.location.href.split('?')[1].split('&')[1].split('=')[1],
            },
            success: function (data) {
                if (data.result == "success"){
                    console.log("success")
                    console.log(data.member_ID)
                    $(".chatroom-member-header").append('<div class="member-title">'+ data.group_name + '(' +  data.member_ID.length + ')' +'</div>');
                    // console.log(data.status)
                    if( (data.member_ID.length > 1) && (window.location.href.split('?')[1].split('&')[0].split('=')[1] == data.leader_ID) && (data.status == "acceptable" || data.status == "full") ){
                        $(".chatroom-member-header").append('<img class="edit-member" src="static/src/edit_new.png" type="button" data-toggle="collapse" data-target=".delete-member">');
                    }
                    
                    var pic_list = data.profile_photo;
                    for(var i = 0; i < data.member_ID.length; i++){
                        $.ajax({
                            url: '/get_img',
                            method: 'POST',
                            type: 'POST',
                            async: false, //改成同步執行(等待上一個回傳)
                            data: {
                                "img_path": pic_list[i],
                            },
                            success: function (img) {
                                if (data.member_ID[i] == data.leader_ID){
                                    $(".chatroom-member-list").append(
                                        '<div class="chatroom-member-item">\
                                            <img style="opacity:0" class="collapse width delete-member" type="button" src="static/src/delete.png" data-toggle="modal" data-target="#delete-member-modal">\
                                            <div class="chatroom-member-photo" onclick=goto_profile("'+ data.member_ID[i] +'") style=" background-image: url(data:image/jpg;base64,' + img + ')"></div>\
                                            <div class="chatroom-member-name" onclick=goto_profile("'+ data.member_ID[i] +'")>'+ data.member_name[i] +'(組長)</div>\
                                        </div>'
                                    )
                                }
                                else{
                                    $(".chatroom-member-list").append(
                                        '<div class="chatroom-member-item">\
                                            <img onclick=create_delete_modal("'+ data.member_ID[i] +'","'+ data.member_name[i] +'") class="collapse width delete-member" type="button" src="static/src/minus_new.png" data-toggle="modal" data-target="#delete-member-modal">\
                                            <div class="chatroom-member-photo" onclick=goto_profile("'+ data.member_ID[i] +'") style=" background-image: url(data:image/jpg;base64,' + img + ')"></div>\
                                            <div class="chatroom-member-name" onclick=goto_profile("'+ data.member_ID[i] +'")>'+ data.member_name[i] +'</div>\
                                        </div>'
                                    )
                                }
                                
                            }
                        });
                    }
                    if( (data.status == "acceptable" || data.status == "full") ){
                        $(".chatroom-member-list").append(
                            '<div class="exit-group">\
                                <div onclick=exit_mission_chatroom() class="exit-group-btn">退出群組</div>\
                            </div>'
                        )
                    }
                }
            }
        });
        
    }

    var edit_state = 0
    $(document).on('click', ".edit-member",function(){
        if(edit_state==0){
            $(".edit-member").attr("src", "static/src/complete.png")
            edit_state = 1
        }
        else{
            $(".edit-member").attr("src", "static/src/edit_new.png")
            edit_state = 0
        }
    })

    function create_delete_modal(others, others_name){
        $("#delete_modal").html(
            '<div class="modal-body">\
                <div class="modal-body-text-confirm">\
                    確定將成員<br>'+ others_name +'<br>從此群組中刪除嗎？\
                </div>\
            </div>\
            <div type="button" class="modal-btn-cancel" data-dismiss="modal">取消</div>\
            <div onclick=kick_mission_chatroom_member("'+ others +'") type="button" class="modal-btn-confirm">確認</div>'
        );
    }

    function kick_mission_chatroom_member(others){
        $.ajax({
            url: '/kick_mission_chatroom_member',
            method: 'POST',
            type: 'POST',
            dataType: "json",
            data: {
                "kicked_ID": others,
                "user_ID": window.location.href.split('?')[1].split('&')[0].split('=')[1],
                "chatroom_ID": window.location.href.split('?')[1].split('&')[1].split('=')[1],
            },
            success: function (data) {
                if (data.result == "success"){
                    // $("#"+this_id+"_div").hide()
                    window.location.href = window.location.href
                    console.log("success")
                }
            }
        });
    }

    function exit_mission_chatroom(){
        $.ajax({
            url: '/exit_mission_chatroom',
            method: 'POST',
            type: 'POST',
            dataType: "json",
            data: {
                "chatroom_ID": window.location.href.split('?')[1].split('&')[1].split('=')[1],
            },
            success: function (data) {
                if (data.result == "success"){
                    console.log("success")
                    window.location.href = "/chatroom?account="+window.location.href.split('?')[1].split('&')[0].split('=')[1];;

                }
            }
        });
    }

    // $("#group_member").click( function() {
    //     window.clearInterval(timeout_update_mission_msg);
    //     $("#chatroom").hide();
    //     $("#group_member").hide();
    //     $("#member").append('<button id="last_page">上一頁</button>')
        
    //     $.ajax({
    //           url: '/get_mission_chatroom_member',
    //           method: 'POST',
    //           type: 'POST',
    //           dataType: "json",
    //           data: {
    //               "chatroom_ID": chatroom_ID,
    //           },
    //           success: function (data) {
    //             if (data.result == "success"){
    //                 console.log("success")
    //                 console.log(data.member_ID)
    //                 if( window.location.href.split('?')[1].split('&')[0].split('=')[1] == data.leader_ID && (data.status == "acceptable" || data.status == "full") ){
    //                     $("#member").append('<button id="edit">編輯成員</button>')
    //                     $("#edit").click( function() {
    //                         for(var i = 0; i < member_ID.length; i++){
    //                             $('#'+member_ID[i]).show();
    //                         }
    //                     })
    //                 }
                    
    //                 member_ID = data.member_ID;
    //                 for(var i = 0; i < data.member_ID.length; i++){
    //                     if (data.member_ID[i] == data.leader_ID){
    //                         $("#member_list").append(
    //                             '<div id="' + data.member_ID[i] + '_div">'+
    //                             "ID: " + data.member_ID[i]+ ' 組長<br>'+
    //                             "name: " + data.member_name[i]+ '<br><br>'+
    //                             // '<button style="display:none" id="' + data.member_ID[i] + '">踢出群組</button><br><br>'
    //                             '</div>'
    //                         )
    //                     }
    //                     else{
    //                          $("#member_list").append(
    //                             '<div id="' + data.member_ID[i] + '_div">'+
    //                             "ID: " + data.member_ID[i]+ '<br>'+
    //                             "name: " + data.member_name[i]+ '<br>'+
    //                             '<button style="display:none" id="' + data.member_ID[i] + '">踢出群組</button><br><br>'+
    //                             '</div>'
    //                         )
    //                         $('#'+data.member_ID[i]).click(function() {
    //                             var this_id = this.id
    //                             $.ajax({
    //                                 url: '/kick_mission_chatroom_member',
    //                                 method: 'POST',
    //                                 type: 'POST',
    //                                 dataType: "json",
    //                                 data: {
    //                                     "kicked_ID": this.id,
    //                                     "user_ID": window.location.href.split('?')[1].split('&')[0].split('=')[1],
    //                                     "chatroom_ID": chatroom_ID,
    //                                 },
    //                                 success: function (data) {
    //                                     if (data.result == "success"){
    //                                         $("#"+this_id+"_div").hide()
    //                                         console.log("success")
    //                                     }
    //                                 }
    //                             });


    //                         })
    //                     }
    //                 }

    //             }
    //           }
    //     });

    // })

    var img_ajax = new Array(0);
    function update_chat_list(){
        $.ajax({
              url: '/get_mission_chatroom_list',
              method: 'POST',
              type: 'POST',
              dataType: "json",
              data: {
                  "account": window.location.href.split('?')[1].split('&')[0].split('=')[1],
                  "search": document.getElementById("chatroom_search").value,
                  "last_chatroom_list" : last_chatroom_list.toString(),
              },
              success: function (data) {
                if (data.result == "success"){
                    for(var i = 0; i < img_ajax.length; i++){
                        console.log("abort",i)
                        img_ajax[i].abort()
                    }

                    last_chatroom_list = data.chatroom_ID
                    
                    $('#chatroom_list_div').html("")
                    for(var i = 0; i < data.chatroom_ID.length; i++){
                        $('#chatroom_list_div').append(
                            '<div class="chatroom-item" type="button" onclick="goto_chatroom(' + data.chatroom_ID[i] + ')">\
                                <div id="list_photo_' + i.toString() + '" class="chatroom-photo"></div>\
                                <div id="list_msg_' + i.toString() + '" class="chatroom-name">' + data.group_name[i] + '</div>\
                                <div class="last-msg">' + data.message[i] + '</div>\
                            </div>'
                        )
                        if(data.status[i]!="friend"){
                            document.getElementById("list_msg_"+ i.toString() ).innerHTML += '(' + data.group_number[i] + ')'
                        }

                        // $.ajax({
                        //     url: '/get_img',
                        //     method: 'POST',
                        //     type: 'POST',
                        //     async: false, //改成同步執行(等待上一個回傳)
                        //     data: {
                        //         "img_path": data.chat_img[i],
                        //     },
                        //     success: function (img) {
                        //         $('#list_photo_'+ i.toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + img + ')' )
                                
                        //     }
                        // });
                    }
                    console.log("len",data.chatroom_ID.length)
                    if(data.chatroom_ID.length == 0){
                        
                        if(document.getElementById("chatroom_search").value==""){
                            $('#chatroom_list_div').append(
                                '<div class="error_text" style="top:25vh;">尚無聊天室<br>快去破任務或加好友吧!</div>'    
                            )
                        }
                        else{
                            $('#chatroom_list_div').append(
                                '<div class="error_text">查無此聊天室名稱!</div>'    
                            )
                        }
                    }
                    else{
                        $('#chatroom_list_div').append(
                            '<div class="chatroom-item" style="background-color: #F59E56; height: 66vw;">\
                            </div>'
                        )
                    }
                    
                    img_ajax = new Array(data.chatroom_ID.length)
                    for(var i = 0; i < data.chatroom_ID.length; i++){
                        console.log(i)
                        img_ajax[i] = $.ajax({
                            url: '/get_img_count',
                            method: 'POST',
                            type: 'POST',
                            // async: false, //改成同步執行(等待上一個回傳)
                            data: {
                                "img_path": data.chat_img[i],
                                "count": i.toString(),
                            },
                            success: function (img) {
                                image = img.split("'")
                                $('#list_photo_'+ image[2].toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + image[1] + ')' )
                            }
                        });
                    }
                    

                    
                }
                else if (data.result=="same"){
                    console.log("same")
                }
              }
        });
    }

    function unpack(str) {
        var bytes = [];
        for(var i = 0; i < str.length; i++) {
            var char = str.charCodeAt(i);
            bytes.push(char >>> 8);
            bytes.push(char & 0xFF);
        }
        return bytes;
    }


    function goto_chatroom(chatroom_ID){
        window.clearInterval(timeout_update_chat_list);                            
        window.location.href = window.location.href + "&chatroom_ID=" + chatroom_ID
    };

    var last_group_number = 0;
    function update_mission_msg(chatroom_ID, first=""){
        account = window.location.href.split('?')[1].split('&')[0].split('=')[1];
        if(chatroom_ID[0]=="2"){
            $.ajax({
                url: '/mission_chatroom_update',
                method: 'POST',
                type: 'POST',
                dataType: "json",
                async: false, //改成同步執行(等待上一個回傳)
                data: {
                    "post_type": "Receive",
                    "chatroom_ID": chatroom_ID,
                    "last_sender_name_len": last_sender_name_len,
                },
                success: function (data) {
                    if (data.result == "success"){
                        // last_sender_name_len = parseInt(data.sender_name.length) + parseInt(data.group_number)
                        chatroom_history = JSON.parse(data.history);

                        // if (first=="first"){
                            $('.chatroom-record-header').html(
                                // '<a href="/chatroom?account=' + account + '">\
                                '<a id="chatroom_back">\
                                    <div class="back_arrow"></div>\
                                </a>\
                                <div class="chatroom-title">' + data.group_name +'(' + data.group_number + ')</div>\
                                <a href="/chatroom?account='+ window.location.href.split('?')[1].split('&')[0].split('=')[1] +'&chatroom_ID='+ chatroom_ID +'&check">\
                                    <img class="check-member" src="static/src/check_member.png">\
                                </a>'       
                            );
                            console.log(document.referrer.split("?")[0].indexOf('friend'))
                            if (document.referrer.split("?")[0].indexOf('friend') > -1){
                                document.getElementById("chatroom_back").href = document.referrer
                            }
                            else{
                                document.getElementById("chatroom_back").href = '/chatroom?account=' + account + ''
                            }
                        // }

                        // html_code = ""
                        // $('#chatroom-record-content-ID').html("")
                        var last_time = new Date("1911/01/01")
                        var today = new Date();
                        var yesterday = new Date(new Date().setTime(today.getTime()-24*60*60*1000))
                        var weekDay = ["日", "一", "二", "三", "四", "五", "六"];
                        for(var i = 0; i < chatroom_history.length; i++){
                            
                            var time_first = 0;
                            var time = new Date(chatroom_history[i].fields.time)
                            var title = ""
                            var hour = "00"
                            var minutes = time.getMinutes().toString();
                            if (time.getHours() >= 12){
                                title = "下午"
                                if (time.getHours()!=12){
                                    hour = (time.getHours()-12).toString();
                                }
                                else{
                                    hour = time.getHours().toString();
                                }
                                    
                            }
                            else if(time.getHours() < 12){
                                title = "上午"
                                hour = time.getHours().toString();
                                if(hour=="0"){
                                    hour="12"
                                }
                            }
                            
                            if (minutes.length==1){
                                minutes = "0"+minutes;
                            }

                            var chat_time = title + hour + ":" + minutes;

                            var date_time_text = "";
                            var time_judge = new Date(time);
                            if(time_judge.setHours(0,0,0,0) != last_time.setHours(0,0,0,0)){
                                last_time = time;
                                time_first = 1;
                                if(time_judge.setHours(0,0,0,0) == today.setHours(0,0,0,0)){
                                    date_time_text = "今天"
                                }
                                else if(time_judge.setHours(0,0,0,0) == yesterday.setHours(0,0,0,0)){
                                    date_time_text = "昨天"
                                }
                                else{
                                    if(time_judge.getFullYear() == today.getFullYear()){
                                        date_time_text = (time.getMonth()+1) + '月' + time.getDate() + '日(' + weekDay[time.getDay()] + ')';
                                    }
                                    else{
                                        date_time_text = time.getFullYear() + '年' + (time.getMonth()+1) + '月' + time.getDate() + '日(' + weekDay[time.getDay()] + ')';
                                    }
                                }
                            }

                            if(i < last_sender_name_len - last_group_number ){
                                continue;
                            }

                            if (chatroom_history[i].fields.sender_ID==account){
                                if(time_first==1){
                                    $("#chatroom-record-content-ID").append(
                                        '<div class="msg_date">\
                                            <div class="msg_date_text">'+
                                                date_time_text+
                                            '</div>\
                                        </div>'
                                    )
                                }

                                $("#chatroom-record-content-ID").append(
                                    '<div class="msg from-me">\
                                        <div class="msg-content-time-flex">\
                                            <div class="msg-content-time from-me">'
                                                +chat_time+
                                            '</div>\
                                        </div>\
                                        <div class="msg-content from-me">'
                                            + chatroom_history[i].fields.message +
                                        '</div>\
                                    </div>'
                                )
                            }
                            else {
                                if(time_first==1){
                                    $("#chatroom-record-content-ID").append(
                                        '<div class="msg_date">\
                                            <div class="msg_date_text">'+
                                                date_time_text+
                                            '</div>\
                                        </div>'
                                    )
                                }

                                $("#chatroom-record-content-ID").append(
                                    '<div class="msg from-others">\
                                        <div class="msg-photo" onclick=goto_profile("' + chatroom_history[i].fields.sender_ID + '") id="msg_photo_' + i.toString() + '"></div>\
                                        <div style="display: block">\
                                            <div class="msg-name">' + data.sender_name[i] + '</div>\
                                            <div class="msg-content from-others">'
                                                + chatroom_history[i].fields.message +
                                            '</div>\
                                        </div>\
                                        <div class="msg-content-time-flex">\
                                            <div class="msg-content-time from-others">'
                                                +chat_time+
                                            '</div>\
                                        </div>\
                                    </div>'
                                )

                                // $.ajax({
                                //     url: '/get_img',
                                //     method: 'POST',
                                //     type: 'POST',
                                //     async: false, //改成同步執行(等待上一個回傳)
                                //     data: {
                                //         "img_path": data.sender_photo[i],
                                //     },
                                //     success: function (img) {
                                //         $('#msg_photo_'+ i.toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + img + ')' )
                                        
                                //     }
                                // });
                            }
                        }
                        
                        for(var i = 0; i < chatroom_history.length; i++){
                            if(i < last_sender_name_len - last_group_number ){
                                continue;
                            }
                            $.ajax({
                                url: '/get_img_count',
                                method: 'POST',
                                type: 'POST',
                                // async: false, //改成同步執行(等待上一個回傳)
                                data: {
                                    "img_path": data.sender_photo[i],
                                    "count": i.toString(),
                                },
                                success: function (img) {
                                    image = img.split("'")
                                    $('#msg_photo_'+ image[2].toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + image[1] + ')' )
                                    
                                }
                            });
                        }
                        last_group_number = 2*parseInt(data.group_number)
                        last_sender_name_len = parseInt(data.sender_name.length) + 2*parseInt(data.group_number)
                        var chat_record = document.getElementById('chatroom-record-content-ID');
                        chat_record.scrollTop = chat_record.scrollHeight;
                    }
                    else if(data.result=="same"){
                        // console.log("same")
                    }
                }
            });
        }
        else if(chatroom_ID[0]=="3"){
            $.ajax({
                url: '/friend_chatroom_update',
                method: 'POST',
                type: 'POST',
                dataType: "json",
                async: false, //改成同步執行(等待上一個回傳)
                data: {
                    "post_type": "Receive",
                    "chatroom_ID": chatroom_ID,
                    "account": window.location.href.split('?')[1].split('&')[0].split('=')[1],
                    "last_sender_name_len": last_sender_name_len,
                },
                success: function (data) {
                    if (data.result == "success"){                        
                        chatroom_history = JSON.parse(data.history);

                        if (first=="first"){
                            $('.chatroom-record-header').html(
                                // '<a href="/chatroom?account=' + account + '">\
                                '<a id="chatroom_back">\
                                    <div class="back_arrow"></div>\
                                </a>\
                                <div class="chatroom-title">' + data.group_name + '</div>'
                            );

                            console.log(document.referrer.split("?")[0].indexOf('friend'))
                            if (document.referrer.split("?")[0].indexOf('friend') > -1){
                                document.getElementById("chatroom_back").href = document.referrer
                            }
                            else{
                                document.getElementById("chatroom_back").href = '/chatroom?account=' + account + ''
                            }
                        }


                        // $('#chatroom-record-content-ID').html("")
                        var last_time = new Date("1911/01/01")
                        var today = new Date();
                        var yesterday = new Date(new Date().setTime(today.getTime()-24*60*60*1000))
                        var weekDay = ["日", "一", "二", "三", "四", "五", "六"];
                        for(var i = 0; i < chatroom_history.length; i++){
                            var time_first = 0;
                            var time = new Date(chatroom_history[i].fields.time)
                            var title = ""
                            var hour = "00"
                            var minutes = time.getMinutes().toString();
                            if (time.getHours() >= 12){
                                title = "下午"
                                if (time.getHours()!=12){
                                    hour = (time.getHours()-12).toString();
                                }
                                else{
                                    hour = time.getHours().toString();
                                }
                            }
                            else if(time.getHours() < 12){
                                title = "上午"
                                hour = time.getHours().toString();
                                if(hour=="0"){
                                    hour="12"
                                }
                            }

                            if (minutes.length==1){
                                minutes = "0"+minutes;
                            }
                            var chat_time = title + hour + ":" + minutes;

                            if(chatroom_history[i].fields.message!=""){
                                var date_time_text = "";
                                var time_judge = new Date(time);
                                if(time_judge.setHours(0,0,0,0) != last_time.setHours(0,0,0,0)){
                                    last_time = time;
                                    time_first = 1;
                                    if(time_judge.setHours(0,0,0,0) == today.setHours(0,0,0,0)){
                                        date_time_text = "今天"
                                    }
                                    else if(time_judge.setHours(0,0,0,0) == yesterday.setHours(0,0,0,0)){
                                        date_time_text = "昨天"
                                    }
                                    else{
                                        if(time_judge.getFullYear() == today.getFullYear()){
                                            date_time_text = (time.getMonth()+1) + '月' + time.getDate() + '日(' + weekDay[time.getDay()] + ')';
                                        }
                                        else{
                                            date_time_text = time.getFullYear() + '年' + (time.getMonth()+1) + '月' + time.getDate() + '日(' + weekDay[time.getDay()] + ')';
                                        }
                                    }
                                }

                                if(i < last_sender_name_len){
                                    continue;
                                }

                                if (chatroom_history[i].fields.sender_ID==account){
                                    if(time_first==1){
                                        $("#chatroom-record-content-ID").append(
                                            '<div class="msg_date">\
                                                <div class="msg_date_text">'+
                                                    date_time_text+
                                                '</div>\
                                            </div>'
                                        )
                                    }
                                    
                                    $("#chatroom-record-content-ID").append(
                                        '<div class="msg from-me">\
                                            <div class="msg-content-time-flex">\
                                                <div class="msg-content-time from-me">'
                                                    +chat_time+
                                                '</div>\
                                            </div>\
                                            <div class="msg-content from-me">'
                                                + chatroom_history[i].fields.message +
                                            '</div>\
                                        </div>'
                                    )
                                }
                                else {
                                    if(time_first==1){
                                        $("#chatroom-record-content-ID").append(
                                            '<div class="msg_date">\
                                                <div class="msg_date_text">'+
                                                    date_time_text+
                                                '</div>\
                                            </div>'
                                        )
                                    }

                                    $("#chatroom-record-content-ID").append(
                                        '<div class="msg from-others">\
                                            <div class="msg-photo"  onclick=goto_profile("' + chatroom_history[i].fields.sender_ID + '") id="msg_photo_' + i.toString() + '"></div>\
                                            <div style="display: block">\
                                                <div class="msg-name">' + data.sender_name[i] + '</div>\
                                                <div class="msg-content from-others">'
                                                    + chatroom_history[i].fields.message +
                                                '</div>\
                                            </div>\
                                            <div class="msg-content-time-flex">\
                                                <div class="msg-content-time from-others">'
                                                    +chat_time+
                                                '</div>\
                                            </div>\
                                        </div>'
                                    )

                                    // $.ajax({
                                    //     url: '/get_img',
                                    //     method: 'POST',
                                    //     type: 'POST',
                                    //     async: false, //改成同步執行(等待上一個回傳)
                                    //     data: {
                                    //         "img_path": data.sender_photo[i],
                                    //     },
                                    //     success: function (img) {
                                    //         $('#msg_photo_'+ i.toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + img + ')' )
                                            
                                    //     }
                                    // });
                                }
                            }
                        }
                        for(var i = 0; i < chatroom_history.length; i++){
                            if(i < last_sender_name_len){
                                continue;
                            }
                            $.ajax({
                                url: '/get_img_count',
                                method: 'POST',
                                type: 'POST',
                                // async: false, //改成同步執行(等待上一個回傳)
                                data: {
                                    "img_path": data.sender_photo[i],
                                    "count": i.toString(),
                                },
                                success: function (img) {
                                    image = img.split("'")
                                    $('#msg_photo_'+ image[2].toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + image[1] + ')' )
                                }
                            });
                        }

                        last_sender_name_len = parseInt(data.sender_name.length)

                        var chat_record = document.getElementById('chatroom-record-content-ID');
                        chat_record.scrollTop = chat_record.scrollHeight;
                    }
                    else if(data.result=="same"){
                        // console.log("same")
                    }
                }
            });
        }
    };

    function goto_profile(others){
        window.location.href = "/profile?account=" + window.location.href.split('?')[1].split('&')[0].split('=')[1] +'&profileID='+ others;
    }

    function send_mission_msg(chatroom_ID){
        var space = document.getElementById("chat-message-input").value;
        var space_check = 0;
        for(var i = 0; i < space.length; i++){
            if(space[i]!=" "){
                space_check = 1;
                break;
            }
        }
        if (space_check){
            if(chatroom_ID[0]=="2"){
                $.ajax({
                    url: '/mission_chatroom_update',
                    method: 'POST',
                    type: 'POST',
                    dataType: "json",
                    async: false, //改成同步執行(等待上一個回傳)
                    data: {
                        "post_type": "Send",
                        "chatroom_ID": chatroom_ID,
                        "sender_ID": window.location.href.split('?')[1].split('&')[0].split('=')[1],
                        "message": document.getElementById("chat-message-input").value
                    },
                    success: function (data) {
                        if (data.result == "success"){
                            // console.log("success")
                        }
                    }
                });
            }
            else if(chatroom_ID[0]=="3"){
                $.ajax({
                    url: '/friend_chatroom_update',
                    method: 'POST',
                    type: 'POST',
                    dataType: "json",
                    async: false, //改成同步執行(等待上一個回傳)
                    data: {
                        "post_type": "Send",
                        "chatroom_ID": chatroom_ID,
                        "sender_ID": window.location.href.split('?')[1].split('&')[0].split('=')[1],
                        "message": document.getElementById("chat-message-input").value
                    },
                    success: function (data) {
                        if (data.result == "success"){
                            // console.log("success")
                        }
                    }
                });
            }
        }
    };

    
    $("#chat-message-submit").click( function() {
        var input = document.getElementById('chat-message-input');
        input.value = input.value.replace("\r\n","\n");
        input.value = input.value.replace("\n","<br>");
        send_mission_msg(chatroom_ID);
        update_mission_msg( chatroom_ID );
        document.getElementById("chat-message-input").value = "";
    });

    $(document).on('click', "#chatroom_search",function(){
        window.clearInterval(timeout_update_chat_list);
        timeout_update_chat_list = window.setInterval( update_chat_list , 500)
        // friend_search_timer = window.setInterval( get_friend_page , 500)
    })

    $('.btn-cancel').click(function(){
        document.getElementById("chatroom_search").value = ""
        update_chat_list();
        window.clearInterval(timeout_update_chat_list);
        timeout_update_chat_list = window.setInterval( update_chat_list , 1000)
    })

    function test(){
        // history.go(-1);
    }


</script>