<!DOCTYPE html>
<html>
    {% load pwa %}
    {% progressive_web_app_meta %}
    <head> 
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="viewport" content="width=device-width; viewport-fit=cover">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta charset="utf-8">
        <!-- <script src="static/jquery.js"></script> -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>        
        <link href="static/mission.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropper/3.1.3/cropper.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropper/3.1.3/cropper.min.js"></script>
        <!-- <link  href="static/cropper.css" rel="stylesheet"> -->
        <!-- <script src="static/cropper.js"></script> -->
    </head>
    <body>
        <div class="header">
            <a id="back_arrow_link">
                <div class="back_arrow"></div>
            </a>
            
            <div class="title_text">任 務</div>
            <div class="btn-help" type="button"></div>
        </div>

        <ul class="nav nav-tabs nav-justified top-tab" style="position: fixed; top: 25vw;">
            <li class="active" id="top-tab-explore">
                <div id="tab-explore" data-toggle="tab" href="#explore-mission" ></div>
            </li>
            <li id="top-tab-my-mission">
                <div id="tab-my-mission" data-toggle="tab" href="#my-mission" ></div>
            </li>
        </ul>
        <div class="tab-footer"></div>
        <div class="body-tab-content tab-content">
            <div id="explore-mission" class="tab-pane fade in active">
                <div class="search-bar">
                    <form class="search">
                        <input id="mission_search" type="search" placeholder=" 輸入任務名稱" class="search-input">
                        <div id="mission_search_delete" type="reset" class="btn_cancel">取消</div>
                    </form>    
                </div> 

                <div class="select-type">
                    <div class="type-select-bar">
                        <div class="type-select-btn">
                            <div href='#type-btn-group'>
                                <div class="select-btn" type="button">類別</div>
                            </div>
                        </div>
                        <div id="type-btn-group">
                            <div class="btn-group">
                                <input type="radio" name="mission-type" id="all">
                                <label for="all" style="left: 5vw;">• 全部</label>
                                <input type="radio" name="mission-type" id="entertainment">
                                <label for="entertainment">• 娛樂</label>
                                <input type="radio" name="mission-type" id="learning">
                                <label for="learning">• 學習</label>
                                <input type="radio" name="mission-type" id="handcraft">
                                <label for="handcraft">• 手作</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="mission_container">
                    <!-- JavaScript append -->
                </div>
            </div> 
            <div id="my-mission" class="tab-pane fade">
                <div class="jf-continer" id = 'page1'>
                    <div id="page1_container"></div>
                    <!-- JavaScript append -->
                </div>
            </div>
        </div>
        

        <a id="home_link">
            <div class="quarter_circle" style="left: 0vw; background-image: url('static/src/home.png');"></div>
        </a>
        <a id="chat_link">
            <div class="quarter_circle" style="right: 0vw; background-image: url('static/src/chat.png');"></div>
        </a>

        <div id="create_group_modal"></div>
        <div id="test_modal"></div>
        <div id="join_group_modal"></div>
        <div id="submit_modal"></div>
        <div id="finished_modal"></div>
        
    </body>
</html>

<script>
    var mission_type = "all";

    $.ajaxSetup({
        data:{csrfmiddlewaretoken:'{{ csrf_token }}'}
    })    

    function getCookie(cookieName) {
        var name = cookieName + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i<ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1);
            if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
        }
        return "";
    }

    window.onload = function(){
        parameter = window.location.href.split('?')
        if(parameter.length == 1){
            parameter[1] = "account=account"
        }
        if( parameter[1].toString().split("&")[0].split('=')[0] != "account" | parameter[1].toString().split("&")[0].split('=')[1] != getCookie("account") ){
            split_q = parameter;
            split_and = parameter[1].split('&');
            split_and[0] = "account=" + getCookie("account");
            loc = split_q[0] + "?"
            for(var i=0; i < split_and.length; i++){
                if (i == split_and.length-1){
                    loc = loc + split_and[i]
                }
                else{
                    loc = loc + split_and[i] + "&"
                }
            }
            window.location.href = loc
        }
        else{
            all_mission();
            document.getElementById('back_arrow_link').href = "/main?account=" + window.location.href.split('?')[1].split('&')[0].split('=')[1];
            document.getElementById('home_link').href = "/main?account=" + window.location.href.split('?')[1].split('&')[0].split('=')[1];
            document.getElementById('chat_link').href = "/chatroom?account=" + window.location.href.split('?')[1].split('&')[0].split('=')[1];
        }
    }

    $('#all').click( function() {
        mission_type = "all"
        all_mission();
    })

    $('#entertainment').click( function() {
        mission_type = "play"
        all_mission();
    })

    $('#learning').click( function() {
        mission_type = "learning"
        all_mission();
    })

    $('#handcraft').click( function() {
        mission_type = "hand"
        all_mission();
    })


    $(document).on('click', "#mission_search",function(){
        mission_search_timer = window.setInterval( all_mission , 500)
        // all_mission();
    })

    $('#mission_search_delete').click(function(){
        window.clearInterval(mission_search_timer);
        document.getElementById("mission_search").value = ""
        all_mission();
    })

    $('#tab-explore').click( function() {
        all_mission();
    })

    $('#tab-my-mission').click( function() {
        my_mission("join");
    })
    
    $(document).on('click', "#finished_t",function(){
        my_mission("finished");
    })

    $(document).on('click',"#joined_t" ,function(){
        my_mission("join");
    })

    // Add select type button group collapsing
    $('.select-btn').click( function(){
        if($('.btn-group').css('visibility') == 'hidden'){
            $('.btn-group').css('visibility', 'visible');
            $('.btn-group').animate({width:"73vw"}, 300);
        }else {
            $('.btn-group').animate({width:"0vw"}, 300);
            setTimeout(function(){
                $('.btn-group').css('visibility', 'hidden');
            }, 300);    
        }
    })

    // ADD GUIDE
    $('.btn-help').click( function(){
        if($('#top-tab-explore').hasClass('active')) {
            if($('.collapse').hasClass('in')) {
                if($('#right-tab').hasClass('active')){
                    Swal.fire({
                        width: '100vw',
                        background: 'url(static/help/m3.png)',
                        showConfirmButton: false,
                        showCloseButton: true,
                        customClass: 'swal-custom-guide'
                    });    
                }else {
                    Swal.fire({
                        width: '100vw',
                        background: 'url(static/help/m2.png)',
                        showConfirmButton: false,
                        showCloseButton: true,
                        customClass: 'swal-custom-guide'
                    });    
                }        
            }else {
                Swal.fire({
                    width: '100vw',
                    background: 'url(static/help/m1.png)',
                    showConfirmButton: false,
                    showCloseButton: true,
                    customClass: 'swal-custom-guide'
                });    
            }        
        }else if($('#top-tab-my-mission').hasClass('active')) {
            if($('#joined_t').css('color') == 'rgb(255, 255, 255)') {
                Swal.fire({
                    width: '100vw',
                    background: 'url(static/help/m4.png)',
                    showConfirmButton: false,
                    showCloseButton: true,
                    customClass: 'swal-custom-guide'
                });        
            }else {
                Swal.fire({
                    width: '100vw',
                    background: 'url(static/help/m5.png)',
                    showConfirmButton: false,
                    showCloseButton: true,
                    customClass: 'swal-custom-guide'
                });
            }
            
        }
        
    })

    var last_my_mission_list = "1"
    var last_page1_container_join = ""
    var last_page1_container_finish = ""
    var last_submit_modal = ""
    function my_mission(type) {
        console.log(last_my_mission_list.toString())
        $.ajax({
            url: '/get_my_mission',
            method: 'POST',
            type: 'POST',
            dataType: "json",
            data: {
            "user_ID": window.location.href.split('?')[1].split('&')[0].split('=')[1],
            "last_my_mission_list": last_my_mission_list.toString(),
            },
            success: function (data) {
                if (data.result == "success"){
                    last_my_mission_list = data.this_my_mission_list
                    
                    $('#page1').html("");
                    $('#submit_modal').html("");
                    if(type=="join"){
                        $('#page1').append(
                            "<div class='top_block'>\
                                <div class='joined_text' id = 'joined_t'>待完成</div>\
                                <div class='finished_text' id ='finished_t'>已完成</div>\
                                <img src = 'static/new_element/asset 321.png' class = 'design_line'>\
                            </div>"
                        )

                    }
                    else if(type=="finished"){
                        $('#page1').append(
                            "<div class='top_block'>\
                                <div class='joined_text' id = 'joined_t' >待完成</div>\
                                <div class='finished_text' id ='finished_t' >已完成</div>\
                                <img src = 'static/new_element/asset 321.png' class = 'design_line'>\
                            </div>"
                        )
                        $('#joined_t').attr('style', "background-image: url(static/new_element/asset320.png); color:rgba(245, 158, 86, 0.8);")
                        $('#finished_t').attr('style', "background-image: url(static/new_element/asset319.png); color:white;")
                    }
                    $('#page1').append('<div id="page1_container"></div><div id="page2_container"></div>')
                    var pic_list = data.mission_pic
                    for(var i = 0; i < pic_list.length; i++){
                        // $.ajax({
                        //     url: '/get_img',
                        //     method: 'POST',
                        //     type: 'POST',
                        //     async: false, //改成同步執行(等待上一個回傳)
                        //     data: {
                        //         "img_path": pic_list[i],
                        //     },
                        //     success: function (img) {
                                // if(type=="join" && (data.status[i]=="acceptable" || data.status[i]=="full")){
                                if((data.status[i]=="acceptable" || data.status[i]=="full")){
                                    // $.ajax({
                                    //     url: '/submit_mission_group_check',
                                    //     method: 'POST',
                                    //     type: 'POST',
                                    //     dataType: "json",
                                    //     async: false,
                                    //     data: {
                                    //         "chatroom_ID": data.chatroom_ID[i],
                                    //     },
                                    //     success: function (enough) {
                                            // if (enough.result == "success"){
                                            if ( data.group_num[i] >= data.group_required[i]){
                                                $('#page1_container').append(
                                                    '<div class="test_block">\
                                                        <div class="joined_mission" style="background-image: url(static/new_element/12.png);"></div>\
                                                        <div id="joined_pic_'+ i.toString() +'" class="joined_pic"></div>\
                                                        <div class="btn-submit" type="button" data-toggle="modal" data-target="#btn-submit-modal'+i.toString()+'">提交</div>\
                                                        <div class = "mission_name">'+ data.mission_name[i] +'</div>\
                                                        <div class = "mission_chat">'+ data.group_name[i] +'</div>\
                                                    </div>'
                                                )
                                                // $('#joined_pic_'+i.toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + img + ')' )

                                                $('#submit_modal').append(
                                                    '<div class="modal fade" id="btn-submit-modal'+ i.toString() +'" tabindex="-1" aria-hidden="true" data-backdrop="static">\
                                                        <div class="submit-modal-dialog">\
                                                            <div class="submit-modal-content">\
                                                                <form id="form' + i.toString() + '">\
                                                                    {% csrf_token %}\
                                                                    <label>\
                                                                        <input id="image-input'+ i.toString() +'" type="file" name="image" style="visibility: hidden;" value="">\
                                                                    </label>\
                                                                    <div type="button" onclick="upload_img('+i.toString()+')"  id="upload_img_'+ i.toString() +'" class="upload_img_div">\
                                                                        <img type="button" id="img_upload_img_'+ i.toString() +'">\
                                                                    </div>\
                                                                </form>\
                                                                <div id="submit-modal-btn-cancel'+ i.toString() +'" onclick="submit_no()" type="button" class="submit-modal-btn-cancel" data-dismiss="modal">取消</div>\
                                                                <div id="submit-modal-btn-confirm'+ i.toString() +'" onclick="submit_yes('+i.toString()+','+data.chatroom_ID[i]+')" type="button" class="submit-modal-btn-confirm" data-dismiss="modal">確認</div>\
                                                            </div>\
                                                        </div>\
                                                    </div>'
                                                )
                                            }
                                            // else if(enough.result == "not_enough"){
                                            else{
                                                $('#page1_container').append(
                                                    '<div class="test_block">\
                                                        <div class="joined_mission"></div>\
                                                        <div id="joined_pic_'+ i.toString() +'" class="joined_pic"></div>\
                                                        <div onclick=not_enough_alert('+ data.group_num[i] +','+ data.group_required[i] +') class="btn-oops" style="font-size:4vw;" type="button">人數不足</div>\
                                                        <div class = "mission_name">'+ data.mission_name[i] +'</div>\
                                                        <div class = "mission_chat">'+ data.group_name[i] +'</div>\
                                                    </div>'
                                                )
                                                // $('#joined_pic_'+i.toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + img + ')' )
                                            }
                                        // }
                                    // });
                                }
                                // else if(type=="finished"){
                                    if(data.status[i]=="checking"){
                                        $('#page2_container').append(
                                            '<div class="test_block">\
                                                <div class="joined_mission" style="background-image: url(static/new_element/complete.png);"></div>\
                                                <div id="joined_pic_'+ i.toString() +'" class="joined_pic"></div>\
                                                <div class="btn-oops" type="button" data-toggle="modal" data-target="#btn-submit-modal">審核中</div>\
                                                <div class = "mission_name">'+ data.mission_name[i] +'</div>\
                                                <div class = "mission_chat">'+ data.group_name[i] +'</div>\
                                            </div>'
                                        )
                                        // $('#joined_pic_'+i.toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + img + ')' )
                                    }
                                    else if(data.status[i]=="finished"){
                                        // $.ajax({
                                        //     url: '/is_shared',
                                        //     method: 'POST',
                                        //     type: 'POST',
                                        //     dataType: "json",
                                        //     async: false,
                                        //     data: {
                                        //         'chatroom_ID': data.chatroom_ID[i],
                                        //     },
                                        //     success: function (shared) {
                                                // if (shared.result == "share"){
                                                if(data.is_shared[i] == "share") {
                                                    $('#page2_container').append(
                                                        '<div class="test_block">\
                                                            <div class="joined_mission" style="background-image: url(static/new_element/12.png);"></div>\
                                                            <div id="joined_pic_'+ i.toString() +'" class="joined_pic"></div>\
                                                            <div onclick=share('+ data.chatroom_ID[i] +') class="btn-finished" type="button" data-toggle="modal" data-target="#btn-submit-modal">分享</div>\
                                                            <div class = "mission_name">'+ data.mission_name[i] +'</div>\
                                                            <div class = "mission_chat">'+ data.group_name[i] +'</div>\
                                                        </div>'
                                                    )
                                                    // $('#joined_pic_'+i.toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + img + ')' )
                                                }
                                                // else if (shared.result == "cancel") {
                                                else if(data.is_shared[i] == "cancel") {
                                                    $('#page2_container').append(
                                                        '<div class="test_block">\
                                                            <div class="joined_mission" style="background-image: url(static/new_element/complete.png);"></div>\
                                                            <div id="joined_pic_'+ i.toString() +'" class="joined_pic"></div>\
                                                            <div onclick=share_cancel('+ data.chatroom_ID[i] +') class="btn-oops" style="font-size:4vw;" type="button" data-toggle="modal" data-target="#btn-submit-modal">取消分享</div>\
                                                            <div class = "mission_name">'+ data.mission_name[i] +'</div>\
                                                            <div class = "mission_chat">'+ data.group_name[i] +'</div>\
                                                        </div>'
                                                    )
                                                    // $('#joined_pic_'+i.toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + img + ')' )
                                                }                
                                            // }
                                        // });

                                        
                                    }
                                    
                                // }
                                
                        //     }
                        // });
                    }

                    // if (pic_list.length == 0){
                    //     $('#page1_container').append( '<div class="error_text" style="top:34vh">尚無參加任務，快去揪團吧!</div>')
                    //     $('#page2_container').append( '<div class="error_text" style="top:34vh">尚無參加任務，快去揪團吧!</div>')
                    // }

                    // $('#page1_container').append(
                    //     '<div class="test_block" style="height: 15vw">\
                    //     </div>'
                    // )
                    // $('#page2_container').append(
                    //     '<div class="test_block" style="height: 15vw">\
                    //     </div>'
                    // )    
                    if (pic_list.length == 0){
                        $('#page1_container').append( '<div class="error_text" style="top:34vh">尚無參加任務，快去揪團吧!</div>')
                        $('#page2_container').append( '<div class="error_text" style="top:34vh">尚無參加任務，快去揪團吧!</div>')
                    }
                    $('#page1_container').append(
                        '<div class="test_block" style="height: 15vw">\
                        </div>'
                    )
                    $('#page2_container').append(
                        '<div class="test_block" style="height: 15vw">\
                        </div>'
                    )

                    last_page1_container_join = $("#page1_container").html()
                    last_page1_container_finish = $("#page2_container").html()
                    last_submit_modal = $("#submit_modal").html()
                    console.log("check-1")

                    if(type=="join"){
                        $("#page1_container").show();
                        $("#page2_container").hide();
                    }
                    else if(type=="finished"){                        
                        $("#page1_container").hide();
                        $("#page2_container").show();
                    }
                    // console.log($("#page1_container").html())

                    for(var i = 0; i < pic_list.length; i++){
                        $.ajax({
                            url: '/get_img_count',
                            method: 'POST',
                            type: 'POST',
                            // async: false, //改成同步執行(等待上一個回傳)
                            data: {
                                "img_path": pic_list[i],
                                "count": i.toString(),
                            },
                            success: function (img) {
                                image = img.split("'")
                                $('#joined_pic_'+ image[2].toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + image[1] + ')' )
                                last_page1_container_join = $("#page1_container").html()
                                last_page1_container_finish = $("#page2_container").html()
                                last_submit_modal = $("#submit_modal").html()
                                console.log("check"+image[2].toString())
                            }
                        });
                    }
                }
                else if(data.result=="same"){
                    $('#page1').html("");
                    $('#submit_modal').html("");
                    if(type=="join"){
                        console.log(last_page1_container_join)
                        console.log(last_page1_container_finish)
                        $('#page1').append(
                            "<div class='top_block'>\
                                <div class='joined_text' id = 'joined_t'>待完成</div>\
                                <div class='finished_text' id ='finished_t'>已完成</div>\
                                <img src = 'static/new_element/asset 321.png' class = 'design_line'>\
                            </div>"
                        )

                    }
                    else if(type=="finished"){
                        console.log(last_page1_container_join)
                        console.log(last_page1_container_finish)
                        $('#page1').append(
                            "<div class='top_block'>\
                                <div class='joined_text' id = 'joined_t' >待完成</div>\
                                <div class='finished_text' id ='finished_t' >已完成</div>\
                                <img src = 'static/new_element/asset 321.png' class = 'design_line'>\
                            </div>"
                        )
                        $('#joined_t').attr('style', "background-image: url(static/new_element/asset320.png); color:rgba(245, 158, 86, 0.8);")
                        $('#finished_t').attr('style', "background-image: url(static/new_element/asset319.png); color:white;")
                    }
                    $('#page1').append('<div id="page1_container"></div><div id="page2_container"></div>')

                    // if(type=="join"){
                        $('#page1_container').html(last_page1_container_join)
                    // }
                    // else if(type=="finished"){
                        $('#page2_container').html(last_page1_container_finish)
                    // }

                    if(type=="join"){
                        $("#page1_container").show();
                        $("#page2_container").hide();
                    }
                    else if(type=="finished"){                        
                        $("#page1_container").hide();
                        $("#page2_container").show();
                    }

                    $('#submit_modal').html(last_submit_modal)

                    // var pic_list = data.mission_pic
                    // for(var i = 0; i < pic_list.length; i++){
                    //     $.ajax({
                    //         url: '/get_img_count',
                    //         method: 'POST',
                    //         type: 'POST',
                    //         // async: false, //改成同步執行(等待上一個回傳)
                    //         data: {
                    //             "img_path": pic_list[i],
                    //             "count": i.toString(),
                    //         },
                    //         success: function (img) {
                    //             image = img.split("'")
                    //             $('#joined_pic_'+ image[2].toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + image[1] + ')' )
                    //         }
                    //     });
                    // }
                }
            }
        });
    }

    function not_enough_alert(group_num, group_required){
        Swal.fire({
            title: '人數不足以提交任務<br>目前'+ group_num +'人,至少'+ group_required +'人!',
            icon: 'error',
            width: '70vw',
            heightAuto: false,
            background: '#E9BBA4',
            showConfirmButton: false,
            customClass: 'swal-custom'
        })
    }

    function share(chartroom_ID) {
        $.ajax({
            url: '/share',
            method: 'POST',
            type: 'POST',
            dataType: "json",
            async: false,
            data: {
                'chatroom_ID': chartroom_ID,
            },
            success: function (data) {
                console.log(data.result)
                if (data.result == "success"){
                    Swal.fire({
                        title: '已成功分享至<br>個人資訊故事牆!',
                        icon: 'success',
                        width: '70vw',
                        heightAuto: false,
                        background: '#E9BBA4',
                        showConfirmButton: false,
                        customClass: 'swal-custom'
                    })
                    // .then(function () {
                    //     my_mission("finished");
                    // });
                    my_mission("finished");
                }
                else if (data.result == "full") {
                    Swal.fire({
                        title: '分享數量已達上限!',
                        icon: 'error',
                        width: '70vw',
                        heightAuto: false,
                        background: '#E9BBA4',
                        showConfirmButton: false,
                        customClass: 'swal-custom'
                    })
                    // .then(function () {
                    //     my_mission("finished");
                    // });
                    my_mission("finished");
                }  
                else if (data.result == "error") {
                    Swal.fire({
                        title: '錯誤!',
                        icon: 'error',
                        width: '70vw',
                        heightAuto: false,
                        background: '#E9BBA4',
                        showConfirmButton: false,
                        customClass: 'swal-custom'
                    }).then(function () {
                        my_mission("finished");
                    });
                }                
            }
        });
    }

    function share_cancel(chartroom_ID) {
        $.ajax({
            url: '/share_cancel',
            method: 'POST',
            type: 'POST',
            dataType: "json",
            async: false,
            data: {
                'chatroom_ID': chartroom_ID,
            },
            success: function (data) {
                console.log(data.result)
                if (data.result == "success"){
                    Swal.fire({
                        title: '已從個人資訊<br>故事牆取消分享!',
                        icon: 'success',
                        width: '70vw',
                        heightAuto: false,
                        background: '#E9BBA4',
                        showConfirmButton: false,
                        customClass: 'swal-custom'
                    })
                    // .then(function () {
                    //     my_mission("finished");
                    // });
                    my_mission("finished");
                }
                else if (data.result == "none") {
                    Swal.fire({
                        title: '錯誤!',
                        icon: 'error',
                        width: '70vw',
                        heightAuto: false,
                        background: '#E9BBA4',
                        showConfirmButton: false,
                        customClass: 'swal-custom'
                    }).then(function () {
                        my_mission("finished");
                    });
                }  
                else if (data.result == "error") {
                    Swal.fire({
                        title: '錯誤!',
                        icon: 'error',
                        width: '70vw',
                        heightAuto: false,
                        background: '#E9BBA4',
                        showConfirmButton: false,
                        customClass: 'swal-custom'
                    }).then(function () {
                        my_mission("finished");
                    });
                }                
            }
        });
    }

    // var image_change = 0;
    // function upload_img(i) {
    //     console.log('#image-input'+i.toString())
    //     $(document).on('change','#image-input'+i.toString(),function () {
    //         image_change = 1;
    //         console.log("change")
    //         var choose_file = $(this)[0].files[0];
    //         var reader = new FileReader();
    //         reader.readAsDataURL(choose_file);
    //         reader.onload = function () {
    //             console.log(reader.result)
    //             $("#upload_img_"+i.toString()).attr("style", 'background-image: url('+reader.result+')')
    //         }
    //     })
    //     console.log('#image-input'+i.toString())
    //     $('#image-input'+i.toString()).click();
    // }

    var $t;
    var image_change = 0;
    var imgNewWidth = 600;  // px
    var imgNewHeight;
    var imgNewSize = 600;  // k
    function upload_img(i) {
        console.log("in")
        $t = $("#img_upload_img_"+i.toString());

        $(document).on('change','#image-input'+i.toString(),function () {
            image_change = 1;
            var choose_file = $(this)[0].files[0];
            if(choose_file){
                var reader = new FileReader();
                reader.onload = function (evt) {
                    let imgSrc = evt.target.result;
                    $t.cropper('replace', imgSrc, false);
                }
                reader.readAsDataURL(choose_file);
            }
            else{
                image_change = 0;
                $("#submit-modal-btn-cancel" + i.toString()).click();

                setTimeout( function(){ 
                    $("#form" + i.toString()).html(
                        '{% csrf_token %}\
                        <label>\
                            <input id="image-input'+ i.toString() +'" type="file" name="image" style="visibility: hidden;" value="">\
                        </label>\
                        <div type="button" onclick="upload_img('+i.toString()+')"  id="upload_img_'+ i.toString() +'" class="upload_img_div">\
                            <img type="button" id="img_upload_img_'+ i.toString() +'">\
                        </div>'
                    ); 
                    image_change = 0;
                }, 200);
            }
            
        })
        $('#image-input'+i.toString()).click();

        // cropper圖片裁剪
        $t.cropper({
            aspectRatio : 1.2,  // 預設比例
            // preview : '#previewImg',  // 預覽檢視
            guides : false,   // 裁剪框的虛線(九宮格)
            autoCropArea : 0.9, // 0-1之間的數值，定義自動剪裁區域的大小，預設0.8
            dragMode: 'crop', // 拖曳模式 crop(Default,新增裁剪框) / move(移動裁剪框&圖片) / none(無動作)
            cropBoxResizable : true, // 是否有裁剪框調整四邊八點
            movable : true, // 是否允許移動圖片
            zoomable : true, // 是否允許縮放圖片大小
            rotatable : false,   // 是否允許旋轉圖片
            zoomOnWheel : true, // 是否允許通過滑鼠滾輪來縮放圖片
            zoomOnTouch : true, // 是否允許通過觸控移動來縮放圖片
            ready : function(e) {  
                console.log('ready!');
            }
        });
    }
    
    function submit_yes(i,chatroom_ID) {
        var newImg;
        var x, y, width, height;
        if(image_change==1){
            // if(0){
            if (!$t.attr("src")) {
                return false;
            } 
            else {
                var cropImg = $("#img_upload_img_"+i.toString()).cropper('getData');
                
                console.log('cropImg', cropImg);
                console.log('cropImg', cropImg.height, cropImg.width);
                x = cropImg.x;
                y = cropImg.y;
                width = cropImg.width;
                height = cropImg.height;

                $.ajax({
                    url: '/submit_mission_group_check',
                    method: 'POST',
                    type: 'POST',
                    dataType: "json",
                    data: {
                        "chatroom_ID": chatroom_ID,
                    },
                    success: function (data) {
                        if (data.result == "success"){
                            var formdata = new FormData();
                            console.log($('#image-input'+i.toString())[0].files[0])
                            formdata.append("image", $('#image-input'+i.toString())[0].files[0]);
                            formdata.append("x", x);
                            formdata.append("y", y);
                            formdata.append("width", width);
                            formdata.append("height", height);
                            formdata.append("chatroom_ID",chatroom_ID);
                            formdata.append("csrfmiddlewaretoken",$("[name='csrfmiddlewaretoken']").val());
                            $.ajax({
                                processData:false,
                                contentType:false,
                                url:'/submit_mission_group',
                                type:'POST',
                                async: false,
                                data:formdata,
                                dataType:"json",
                                success: function (data) {
                                    // alert("提交完成")
                                    $('#submit-modal-btn-confirm'+ i.toString()).attr('data-dismiss', "modal");
                                    // window.location.href = "/mission?account=" + window.location.href.split('?')[1].split('&')[0].split('=')[1];
                                    Swal.fire({
                                        title: '提交完成!',
                                        icon: 'success',
                                        width: '70vw',
                                        heightAuto: false,
                                        background: '#E9BBA4',
                                        showConfirmButton: false,
                                        customClass: 'swal-custom'
                                    }).then(function () {
                                        $('#tab-my-mission').click();
                                    });
                                }
                            });
                        }
                        else if(data.result=="not_enough"){
                            // alert("人數不足以提交任務")
                            $("#submit-modal-btn-confirm"+ i.toString()).attr('data-dismiss', "modal");
                            Swal.fire({
                                title: '人數不足以提交任務!',
                                icon: 'error',
                                width: '70vw',
                                heightAuto: false,
                                background: '#E9BBA4',
                                showConfirmButton: false,
                                customClass: 'swal-custom'
                            }).then(function () {
                                $('#tab-my-mission').click();
                            });
                        }
                        else if(data.result=="error"){
                            // alert("error")
                            $("#submit-modal-btn-confirm"+ i.toString()).attr('data-dismiss', "modal");
                            Swal.fire({
                                title: '出現錯誤，請再試一次!',
                                icon: 'error',
                                width: '70vw',
                                heightAuto: false,
                                background: '#E9BBA4',
                                showConfirmButton: false,
                                customClass: 'swal-custom'
                            }).then(function () {
                                $('#tab-my-mission').click();
                            });
                        }
                    }
                });

            }
            
        }
        else{
            // alert("請上傳照片!")
            Swal.fire({
                title: '請上傳相片！',
                icon: 'warning',
                width: '70vw',
                heightAuto: false,
                background: '#E9BBA4',
                showConfirmButton: false,
                customClass: 'swal-custom'
            });
        }
        image_change = 0;
    }


    function submit_no() {
        // image_change = 0;
    }

    var last_mission_list = ""
    function all_mission() {
        $.ajax({
              url: '/get_all_mission',
              method: 'POST',
              type: 'POST',
              dataType: "json",
              data: {
                  "search": document.getElementById("mission_search").value,
                  "mission_type": mission_type,
                  "last_mission_list": last_mission_list.toString(),
              },
              success: function (data) {
                if (data.result == "success"){
                    last_mission_list = data.mission_ID
                    $('#mission_container').html("");
                    var pic_list = data.mission_pic
                    if(pic_list.length == 0){
                        $("#mission_container").html('<div class="error_text">搜尋不到此任務名稱!</div>'  )
                    }
                    else{
                        for(var i = 0; i < pic_list.length; i++){
                            // $.ajax({
                            //     url: '/get_img',
                            //     method: 'POST',
                            //     type: 'POST',
                            //     async: false, //改成同步執行(等待上一個回傳)
                            //     data: {
                            //         "img_path": pic_list[i],
                            //     },
                            //     success: function (img) {
                                    $('#mission_container').append(                             
                                        '<div class="mission-card">\
                                            <div class="card-header">\
                                                <div href="#collapse'+ i.toString() +'" data-toggle="collapse" data-parent="#explore-mission">\
                                                    <div class="card-img" id="all_mission_photo_'+ i.toString() +'">\
                                                        <div class="card-people">'+data.group_required[i]+'人</div>\
                                                    </div>\
                                                    <div class="mission-title">'+ data.mission_name[i] +'</div>\
                                                    <div class="mission-joined">已有'+ data.joined[i]  +'人參加</div>\
                                                    <div class="mission-exp">\
                                                        <div class="exp-val red">+'+ data.exp1[i] +'</div>\
                                                        <div class="exp-val yellow">+'+ data.exp2[i] +'</div>\
                                                        <div class="exp-val blue">+'+ data.exp3[i] +'</div>\
                                                    </div>\
                                                </div>\
                                            </div>\
                                            <div id="collapse' + i.toString() + '"class="collapse">\
                                                <div class="card-body">\
                                                    <ul class="nav nav-tabs nav-justified mission-info-tab">\
                                                        <li id="left-tab" class="active">\
                                                            <a data-toggle="tab" href="#mission-intro'+ i.toString() +'">任務介紹</a>\
                                                        </li>\
                                                        <li id="right-tab">\
                                                            <a data-toggle="tab" onclick="mission_signup(' + data.mission_ID[i] + "," + data.group_required[i] + ')" href="#mission-signup_'+ data.mission_ID[i] +'">揪團報名</a>\
                                                        </li>\
                                                    </ul>\
                                                    <div class="tab-content card-tab-content">\
                                                        <div id="mission-intro'+ i.toString() +'" class="tab-pane fade in active">\
                                                            <div class="mission-intro-content">\
                                                                ' +data.mission_intro[i]+ '\
                                                            </div>\
                                                        </div>\
                                                        <div id="mission-signup_'+ data.mission_ID[i] +'" class="tab-pane fade">\
                                                            <div class="btn-create-group" type="button" data-toggle="modal" data-target="#create-group-modal">我要開團</div>\
                                                            <div id="mission_group_box_'+ data.mission_ID[i] +'" class="group-item-box">'+
                                                                // <div class="group-item">\
                                                                //     <div class="group-name">團名團名</div>\
                                                                //     <div class="group-need">缺5人</div>\
                                                                //     <button></button>\
                                                                // </div>\
                                                                // <div class="group-item">\
                                                                //     <div class="group-name">團名團名</div>\
                                                                //     <div class="group-need">缺5人</div>\
                                                                //     <button></button>\
                                                                // </div>\
                                                                // <div class="group-item">\
                                                                //     <div class="group-name">團名團名</div>\
                                                                //     <div class="group-need">缺5人</div>\
                                                                //     <button></button>\
                                                                // </div>\
                                                                // <div class="group-item">\
                                                                //     <div class="group-name">團名團名</div>\
                                                                //     <div class="group-need">缺5人</div>\
                                                                //     <button></button>\
                                                                // </div>\
                                                            '</div>\
                                                        </div>\
                                                    </div>\
                                                </div>\
                                            </div>\
                                        </div>'
                                    )
                                // }
                            // });
                        }

                        for(var i = 0; i < pic_list.length; i++){
                            $.ajax({
                                url: '/get_img_count',
                                method: 'POST',
                                type: 'POST',
                                // async: false, //改成同步執行(等待上一個回傳)
                                data: {
                                    "img_path": pic_list[i],
                                    "count": i.toString(),
                                },
                                success: function (img) {
                                    image = img.split("'")
                                    $('#all_mission_photo_'+ image[2].toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + image[1] + ')' )
                                }
                            });
                        }

                        $('#mission_container').append(                             
                            '<div class="mission-card">\
                                <div class="card-header" style="background-color: white; height: 20vw;">\
                                </div>\
                            </div>'
                        )
                    }
                }
                else if(data.result=="same"){
                    
                }
              }
        });
    }

    


    function mission_signup(mission_ID,group_required){
        console.log(mission_ID)
        $('#mission_group_box_'+mission_ID).html("")
        $.ajax({
              url: '/get_mission_group',
              method: 'POST',
              type: 'POST',
              dataType: "json",
              data: {
                  "user_ID": window.location.href.split('?')[1].split('=')[1],
                  "mission_ID": mission_ID,
              },
              success: function (data) {
                if (data.result == "success"){
                    html_code = ""
                    for(var i = 0; i < data.chatroom_ID.length; i++){
                        $('#mission_group_box_'+mission_ID).append(
                            '<div class="group-item">\
                                <div class="group-name">' + data.group_name[i] + '<br>目前: '+ data.group_now[i] +'人<br>尚缺: '+ (parseInt(data.group_most[i], 10) - parseInt(data.group_now[i], 10)).toString() +'人</div>\
                                <div>\
                                    <button class="btn-join" data-toggle="modal" data-target="#join-group-modal_' + data.chatroom_ID[i] + '"></button>\
                                    <div class="click-text">點擊加入</div>\
                                </div>\
                            </div>'
                        )

                        html_code += 
                            '<div class="modal fade" id="join-group-modal_' + data.chatroom_ID[i] + '" tabindex="-1" aria-hidden="true" data-backdrop="static">\
                                <div class="modal-dialog">\
                                    <div class="modal-content" style="height: 48vw;">\
                                        <div class="modal-body">\
                                            <div class="modal-body-text-confirm">\
                                                確定加入<br>' +
                                                data.group_name[i]+
                                                '<br>並報名此活動？\
                                            </div>\
                                        </div>\
                                        <div type="button" class="modal-btn-cancel" data-dismiss="modal">取消</div>\
                                        <div type="button" id="modal-btn-confirm-id_' + data.chatroom_ID[i] + '" class="modal-btn-confirm" onclick="join_group('+ mission_ID + ',' + data.chatroom_ID[i] +')">確認</div>\
                                    </div>\
                                </div>\
                            </div>'
                    }
                    $("#join_group_modal").html(html_code);

                    $('#create_group_modal').html(
                        '<div class="modal fade" id="create-group-modal" tabindex="-1" aria-hidden="true" data-backdrop="static">\
                            <div class="modal-dialog">\
                                <div class="modal-content">\
                                    <div class="modal-body">\
                                        <input id="group_name" type="text" placeholder="輸入團名(最多10字)" class="modal-input-group-name"><br>\
                                        <input id="group_most" type="number" placeholder="輸入人數(最少'+ group_required + '人)" class="modal-input-group-people"><br>\
                                        <div class="modal-body-text">\
                                            按下確認自動報名<br>\
                                            且建立聊天群組\
                                        </div>\
                                    </div>\
                                    <div type="button" class="modal-btn-cancel" data-dismiss="modal">取消</div>\
                                    <div type="button" id="modal-btn-confirm-id" class="modal-btn-confirm" onclick="create_group('+ mission_ID + ',' + group_required +')">確認</div>\
                                </div>\
                            </div>\
                        </div>'
                    )

                }
                console.log("success")
              }
        });
    }


    function create_group(mission_ID, group_required){

        var group_name = document.getElementById("group_name").value
        var group_most = document.getElementById("group_most").value

        if( group_name=="" || group_most==""){
            // alert("團名或人數不得為空");
            Swal.fire({
                title: '團名或人數不得為空!',
                icon: 'error',
                width: '70vw',
                heightAuto: false,
                background: '#E9BBA4',
                showConfirmButton: false,
                customClass: 'swal-custom'
            });
        }
        else{
            if (group_name.length > 10){
                // alert("團名不得超過10字");
                Swal.fire({
                    title: '團名不得超過十個字!',
                    icon: 'error',
                    width: '70vw',
                    heightAuto: false,
                    background: '#E9BBA4',
                    showConfirmButton: false,
                    customClass: 'swal-custom'
                });
            }
            else {
                if ( Number.isInteger( parseInt(group_most, 10) ) ){
                    if (group_most < group_required){
                        // alert("人數不得低於"+ group_required +"人");
                        var temp = "人數不得低於"+ group_required +"人!";
                        Swal.fire({
                            title: temp,
                            icon: 'error',
                            width: '70vw',
                            heightAuto: false,
                            background: '#E9BBA4',
                            showConfirmButton: false,
                            customClass: 'swal-custom'
                        });
                    }
                    else {
                        $('#modal-btn-confirm-id').attr('data-dismiss', "modal");

                        $.ajax({
                          url: '/create_mission_group',
                          method: 'POST',
                          type: 'POST',
                          dataType: "json",
                          data: {
                            "group_name": group_name,
                            "mission_ID": mission_ID,
                            "leader_ID": window.location.href.split('?')[1].split('&')[0].split('=')[1],
                            "group_most": group_most,
                          },
                          success: function (data) {
                            if (data.result == "success"){
                                // 前往對應創出來的 chatroom 
                                window.location.href = "/chatroom?account=" + window.location.href.split('?')[1].split('&')[0].split('=')[1] + "&chatroom_ID=" + data.chatroom_ID
                            }
                            
                          }
                        });
                    }
                }
                else {
                    // alert("人數必須為整數");
                    Swal.fire({
                        title: '人數必須為整數!',
                        icon: 'error',
                        width: '70vw',
                        heightAuto: false,
                        background: '#E9BBA4',
                        showConfirmButton: false,
                        customClass: 'swal-custom'
                    });
                }
            }
        }        
    }


    function join_group(mission_ID, chatroom_ID){
        $.ajax({
              url: '/join_mission_group',
              method: 'POST',
              type: 'POST',
              dataType: "json",
              data: {
                "user_ID": window.location.href.split('?')[1].split('&')[0].split('=')[1],
                "mission_ID": mission_ID,
                "chatroom_ID": chatroom_ID,
              },
              success: function (data) {
                if (data.result == "success"){
                    $('#modal-btn-confirm-id_' + chatroom_ID).attr('data-dismiss', "modal");
                    // 前往對應的 chatroom 
                    window.location.href = "/chatroom?account=" + window.location.href.split('?')[1].split('&')[0].split('=')[1] + "&chatroom_ID=" + chatroom_ID
                }
                else if (data.result == "group_full"){
                    $('#modal-btn-confirm-id_' + chatroom_ID).attr('data-dismiss', "modal");
                    // alert("此團已額滿")
                    Swal.fire({
                        title: '此團已額滿!',
                        icon: 'error',
                        width: '70vw',
                        heightAuto: false,
                        background: '#E9BBA4',
                        showConfirmButton: false,
                        customClass: 'swal-custom'
                    });
                }
                else if (data.result == "group_repeat"){
                    $('#modal-btn-confirm-id_' + chatroom_ID).attr('data-dismiss', "modal");
                    // alert("您已在此團中")
                    Swal.fire({
                        title: '您已在此團中!',
                        icon: 'error',
                        width: '70vw',
                        heightAuto: false,
                        background: '#E9BBA4',
                        showConfirmButton: false,
                        customClass: 'swal-custom'
                    });
                }
                
              }
        });
    }


</script>