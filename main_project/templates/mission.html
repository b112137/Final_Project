<!DOCTYPE html>
<html>
    <head> 
        <meta charset="utf-8">
        <script src="static/jquery.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>        
        <link href="static/mission.css" rel="stylesheet">
    </head>
    <body>
        <div class="header">
            <div class="back_arrow"></div>
            <div class="title_text">任 務</div>
        </div>

        <ul class="nav nav-tabs nav-justified top-tab" style="position: fixed; top: 22vw;">
            <li class="active">
                <img id="tab-explore" data-toggle="tab" href="#explore-mission" src="static/src/icon_tab_explore.png">
            </li>
            <li>
                <img id="tab-my-mission" data-toggle="tab" href="#my-mission" src="static/src/icon_tab_my_mission.png">
            </li>
        </ul>
        <div class="tab-content">
            <div id="explore-mission" class="tab-pane fade in active">
                <div class="search-bar">
                    <form class="search">
                        <!-- <img src="src/search.png" class="mission-search-icon"> -->
                        <input type="search" placeholder=" 搜尋" class="search-input">
                        <button type="reset" class="btn_cancel">取消</button>
                    </form>    
                </div> 

                <div class="select-type">
                    <div class="type-select-bar">
                        <div class="type-select-btn">
                            <div href='#type-btn-group' data-toggle="collapse" data-parent="#type-select-bar">
                                <div class="select-btn">類別</div>
                            </div>
                        </div>
                        <div id="type-btn-group" class="collapse">
                            <div class="btn-group">
                                <button id="useless-btn" disabled></button>
                                <button id="entertainment">• 娛樂 </button>
                                <button id="learning">• 學習</button>
                                <button id="handcraft">• 手作</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="mission_container">


                </div>

                <!-- <div class="mission-card">
                    <div class="card-header">
                        <div href='#collapse1' data-toggle="collapse" data-parent="#explore-mission">
                            <div class="card-img"></div>
                            <div class="mission-title">任務名稱</div>
                            <div class="mission-joined">已有15人參加</div>
                            <div class="mission-exp">
                                <div class="exp-val">
                                    <p>+5</p><p>+5</p><p>+5</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="collapse1" class="collapse">
                        <div class="card-body">
                            <ul class="nav nav-tabs nav-justified mission-info-tab">
                                <li id="left-tab" class="active">
                                    <a data-toggle="tab" href="#mission-intro1">任務介紹</a>
                                </li>
                                <li id="right-tab">
                                    <a data-toggle="tab" href="#mission-signup1">揪團報名</a>
                                </li>
                            </ul>
                            <div class="tab-content card-tab-content">
                                <div id="mission-intro1" class="tab-pane fade in active">
                                    <div class="mission-intro-content">
                                        我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣
                                        我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣
                                        我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣
                                        我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣
                                        我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣
                                    </div>
                                </div>
                                <div id="mission-signup1" class="tab-pane fade">
                                    <button class="btn-create-group">我要開團</button>
                                    <div class="group-item-box">
                                        <div class="group-item">
                                            <div class="group-name">團名團名</div>
                                            <div class="group-need">缺5人</div>
                                            <button></button>
                                        </div>
                                        <div class="group-item">
                                            <div class="group-name">團名團名</div>
                                            <div class="group-need">缺5人</div>
                                            <button></button>
                                        </div>
                                        <div class="group-item">
                                            <div class="group-name">團名團名</div>
                                            <div class="group-need">缺5人</div>
                                            <button></button>
                                        </div>
                                        <div class="group-item">
                                            <div class="group-name">團名團名</div>
                                            <div class="group-need">缺5人</div>
                                            <button></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mission-card">
                    <div class="card-header">
                        <div href='#collapse2' data-toggle="collapse" data-parent="#explore-mission">
                            <div class="card-img"></div>
                            <div class="mission-title">任務名稱</div>
                            <div class="mission-joined">已有15人參加</div>
                            <div class="mission-exp">
                                <div class="exp-val">
                                    <p>+5</p><p>+5</p><p>+5</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="collapse2" class="collapse">
                        <div class="card-body">
                            <ul class="nav nav-tabs nav-justified mission-info-tab">
                                <li id="left-tab" class="active">
                                    <a data-toggle="tab" href="#mission-intro2">任務介紹</a>
                                </li>
                                <li id="right-tab">
                                    <a data-toggle="tab" href="#mission-signup2">揪團報名</a>
                                </li>
                            </ul>
                            <div class="tab-content card-tab-content">
                                <div id="mission-intro2" class="tab-pane fade in active">
                                    <div class="mission-intro-content">
                                        我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣
                                        我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣
                                        我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣
                                        我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣
                                        我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣我是文宣
                                    </div>
                                </div>
                                <div id="mission-signup2" class="tab-pane fade">
                                    <button class="btn-create-group">我要開團</button>
                                    <div class="group-item-box">
                                        <div class="group-item">
                                            <div class="group-name">團名團名</div>
                                            <div class="group-need">缺5人</div>
                                            <button></button>
                                        </div>
                                        <div class="group-item">
                                            <div class="group-name">團名團名</div>
                                            <div class="group-need">缺5人</div>
                                            <button></button>
                                        </div>
                                        <div class="group-item">
                                            <div class="group-name">團名團名</div>
                                            <div class="group-need">缺5人</div>
                                            <button></button>
                                        </div>
                                        <div class="group-item">
                                            <div class="group-name">團名團名</div>
                                            <div class="group-need">缺5人</div>
                                            <button></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> -->

            </div>
            <div id="my-mission" class="tab-pane fade">
                <h3>Menu 1</h3>
                <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
            </div>
        </div>
        
        <div class="quarter_circle" style="left: 0vw; background-image: url('static/src/home.png');"></div>
        <div class="quarter_circle" style="right: 0vw; background-image: url('static/src/chat.png');"></div>
        <!-- <script src="mission.js"></script> -->
    </body>
</html>

<script>
    $.ajaxSetup({
        data:{csrfmiddlewaretoken:'{{ csrf_token }}'}
    })    

    window.onload = function(){
        $.ajax({
              url: '/get_all_mission',
              method: 'POST',
              type: 'POST',
              dataType: "json",
              data: {
              },
              success: function (data) {
                if (data.result == "success"){
                    var pic_list = data.mission_pic
                    for(var i = 0; i < pic_list.length; i++){
                        $.ajax({
                        url: '/get_all_mission_img',
                        method: 'POST',
                        type: 'POST',
                        async: false, //改成同步執行(等待上一個回傳)
                        data: {
                            "img_path": pic_list[i],
                        },
                        success: function (img) {
                            console.log("success")
                            $('#mission_container').append(                             
                                '<div class="mission-card">\
                                    <div class="card-header">\
                                        <div href="#collapse'+ i.toString() +'" data-toggle="collapse" data-parent="#explore-mission">\
                                            <div class="card-img" style="background-size: cover; background-image: url(data:image/jpg;base64,' + img + ')">\
                                            </div>\
                                            <div class="mission-title">'+ data.mission_name[i] +'</div>\
                                            <div class="mission-joined">已有'+ data.joined[i]  +'人參加</div>\
                                            <div class="mission-exp">\
                                                <div class="exp-val">\
                                                    <p>'+ data.exp1[i] +'</p><p>' + data.exp2[i] + '</p><p>' + data.exp3[i] +'</p>\
                                                </div>\
                                            </div>\
                                        </div>\
                                    </div>\
                                    <div id="collapse' + i.toString() + '"class="collapse">\
                                        <div class="card-body">\
                                            <ul class="nav nav-tabs nav-justified mission-info-tab">\
                                                <li id="left-tab" class="active">\
                                                    <a data-toggle="tab" href="#mission-intro'+ i.toString() +'">任務介紹</a>\
                                                </li>\
                                                <li id="right-tab">\
                                                    <a data-toggle="tab" onclick="mission_signup(' + data.mission_ID[i] + ')" href="#mission-signup_'+ data.mission_ID[i] +'">揪團報名</a>\
                                                </li>\
                                            </ul>\
                                            <div class="tab-content card-tab-content">\
                                                <div id="mission-intro'+ i.toString() +'" class="tab-pane fade in active">\
                                                    <div class="mission-intro-content">\
                                                        ' +data.mission_intro[i]+ '\
                                                    </div>\
                                                </div>\
                                                <div id="mission-signup_'+ data.mission_ID[i] +'" class="tab-pane fade">\
                                                    <button class="btn-create-group">我要開團</button>\
                                                    <div id="mission_group_box_'+ data.mission_ID[i] +'" class="group-item-box">'+
                                                        // <div class="group-item">\
                                                        //     <div class="group-name">團名團名</div>\
                                                        //     <div class="group-need">缺5人</div>\
                                                        //     <button></button>\
                                                        // </div>\
                                                        // <div class="group-item">\
                                                        //     <div class="group-name">團名團名</div>\
                                                        //     <div class="group-need">缺5人</div>\
                                                        //     <button></button>\
                                                        // </div>\
                                                        // <div class="group-item">\
                                                        //     <div class="group-name">團名團名</div>\
                                                        //     <div class="group-need">缺5人</div>\
                                                        //     <button></button>\
                                                        // </div>\
                                                        // <div class="group-item">\
                                                        //     <div class="group-name">團名團名</div>\
                                                        //     <div class="group-need">缺5人</div>\
                                                        //     <button></button>\
                                                        // </div>\
                                                    '</div>\
                                                </div>\
                                            </div>\
                                        </div>\
                                    </div>\
                                </div>'
                             )
                        }
                        });
                    }
                }
              }
        });
    }


    function mission_signup(mission_ID){
        console.log(mission_ID)
        $('#mission_group_box_'+mission_ID).html("")
        $.ajax({
              url: '/get_mission_group',
              method: 'POST',
              type: 'POST',
              dataType: "json",
              data: {
                  "user_ID": window.location.href.split('?')[1].split('=')[1],
                  "mission_ID": mission_ID,
              },
              success: function (data) {
                if (data.result == "success"){
                    for(var i = 0; i < data.chatroom_ID.length; i++){
                        $('#mission_group_box_'+mission_ID).append(
                            '<div class="group-item">\
                                <div class="group-name">' + data.group_name[i] + '</div>\
                                <div class="group-need">' + (parseInt(data.group_most[i], 10) - parseInt(data.group_now[i], 10)).toString()  + '</div>\
                                <button></button>\
                            </div>'
                        )
                    }
                }
                console.log("success")
              }
        });
    }


    function create_group(mission_ID){
        console.log(mission_ID)
        $.ajax({
              url: '/create_mission_group',
              method: 'POST',
              type: 'POST',
              dataType: "json",
              data: {
                //"group_name": document.getElementById("group_name").value,
                "mission_ID": mission_ID,
                "leader_ID": window.location.href.split('?')[1].split('=')[1],
                //"group_most": document.getElementById("group_most").value,
              },
              success: function (data) {
                if (data.result == "success"){
                    // 前往對應創出來的 chatroom 
                    // TODO
                }
                console.log("success")
              }
        });
    }


    function join_group(mission_ID, chatroom_ID){
        console.log(mission_ID, chatroom_ID)
        $.ajax({
              url: '/join_mission_group',
              method: 'POST',
              type: 'POST',
              dataType: "json",
              data: {
                "user_ID": window.location.href.split('?')[1].split('=')[1],
                "mission_ID": mission_ID,
                "chatroom_ID": chatroom_ID,
              },
              success: function (data) {
                if (data.result == "success"){
                    // 前往對應創出來的 chatroom 
                    // TODO
                }
                console.log("success")
              }
        });
    }


</script>