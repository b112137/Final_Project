<!DOCTYPE html>
<html>
    <head> 
        <meta charset="utf-8">
        <script src="static/jquery.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>        
        <link href="static/shop.css" rel="stylesheet">
    </head>
    <body>
        <div class="shop_header">
            <a id="back_arrow_link">
                <div class="last_arrow"></div>
            </a>
            
            
            <div class="shop_text">商 店</div>
        </div>

        <ul class="nav nav-tabs nav-justified shop-tab" style="position: fixed; top: 22.9183vw;">
            <li class="active">
                <div id="tab-shopping" data-toggle="tab" href="#shopping" ></div>
            </li>
            <li>
                <div id="tab-owned" data-toggle="tab" href="#owned" ></div>
            </li>
        </ul>
        <div class="shop-footer"></div>
        <div class="shop-tab-content tab-content">
            <div id="shopping" class="tab-pane fade in active">
                    <!-- JavaScript append -->
                    <div id="shop_container" class="shop-container">
                        <!-- JavaScript append -->
                    </div>
            </div>

            <div id="owned" class="tab-pane fade">
                <div id="owned_container" class="owned-container">
                    <!-- JavaScript append -->
                </div>
            </div> 
 
        </div>
    
        <a id="home_link">
            <div class="quarter_circle" style="left: 0vw; background-image: url('static/src/home.png');"></div>
        </a>
        <a id="chat_link">
            <div class="quarter_circle" style="right: 0vw; background-image: url('static/src/chat.png');"></div>
        </a>
        <div id="modal_page1">
            <div id="balance_after">
                用戶餘額
                <br>
                <p id="Deduct"></p>
            </div>
        </div>
        <div id="modal_page2">
            <div id="qrcode">
                <img src="static/src/qrcode.PNG">
            </div>
        </div>
    </body>
    <script>
        $.ajaxSetup({
            data:{csrfmiddlewaretoken:'{{ csrf_token }}'}
        }) 

        window.onload = function(){
            document.getElementById('back_arrow_link').href = "/main?account=" + window.location.href.split('?')[1].split('&')[0].split('=')[1];
            document.getElementById('home_link').href = "/main?account=" + window.location.href.split('?')[1].split('&')[0].split('=')[1];
            document.getElementById('chat_link').href = "/chatroom?account=" + window.location.href.split('?')[1].split('&')[0].split('=')[1];
            get_shop_page();
        }

        

        $('#tab-shopping').click( function() {
            get_shop_page();
        })

        $('#tab-owned').click( function() {
            get_my_shop();
        })

        function get_shop_page(){
            $.ajax({
                url: '/get_shop_page',
                method: 'POST',
                type: 'POST',
                dataType: "json",
                data: {
                    "account": window.location.href.split('?')[1].split('&')[0].split('=')[1],
                    "search": "all",
                },
                success: function (data) {
                    if (data.result == "success"){
                        $('#shop_container').html("");
                        var pic_list = data.product_pic
                        console.log(data.balance)
                        $('#shop_container').append( '<p id="balance">用戶餘額:$'+data.balance+'</p>')
                        for(var i = 0; i < pic_list.length; i++){
                            $.ajax({
                            url: '/get_img',
                            method: 'POST',
                            type: 'POST',
                            async: false, //改成同步執行(等待上一個回傳)
                            data: {
                                "img_path": pic_list[i],
                            },
                            success: function (img) {
                                $('#shop_container').append(
                                    '<div id="item1">\
                                        <div class="product" >\
                                            <div class="shop_card-header">\
                                                <div href="#collapse'+ i.toString() +'" data-toggle="collapse" data-parent="#shopping">\
                                                        <div class="product_information" >\
                                                            <div class="product_pic" id="product_pic'+ i.toString()+'"></div>\
                                                            <p class="product_name" id="product1">'+ data.product_name[i] +'</p>\
                                                            <p class="product_discount" id="discount1"></p>\
                                                            <p class="product_date" id="date1">期限:2021/5/6</p>\
                                                        </div>\
                                                </div>\
                                            </div>\
                                            <div class="right">\
                                                <p class="price" id="price1">$'+ data.product_price[i] +'</p>\
                                                <button type="button" class="btn_buy" id="Buy1" onclick=buy_product('+ data.product_ID[i] +','+ data.product_price[i] +') >Buy</button>\
                                            </div>\
                                        </div>\
                                        <div>\
                                        <div id="collapse'+ i.toString() +'" class="collapse" aria-expanded="false" style="height: 0px;">\
                                            <div class="shop_card-body">\
                                                <p class="product_detail">'+ data.product_detail[i] +'</p>\
                                            </div>\
                                        </div>\
                                        </div>\
                                    </div>'
                                )
                                $('#product_pic'+i.toString()).attr('style', 'background-image: url(data:image/jpg;base64,' + img + ')' )
                            }
                            });
                        }
                        
                        $('#shop_container').append(
                            '<div class="shop-container">\
                                <div id="item1">\
                                    <div class="product" >\
                                        <div class="shop_card-header" style="height: 20vw">\
                                        </div>\
                                        <div class="right">\
                                        </div>\
                                    </div>\
                                    <div id="collapse'+ (i+1).toString() +'" class="collapse" aria-expanded="false" style="height: 0px;">\
                                    </div>\
                                </div>\
                            </div>'
                        )
                    }
                }
            });
        }

        function buy_product(product_ID, price){
            $.ajax({
                url: '/buy_product',
                method: 'POST',
                type: 'POST',
                dataType: "json",
                data: {
                    'account': window.location.href.split('?')[1].split('&')[0].split('=')[1],
                    'product_ID': product_ID,
                },
                success: function (data) {
                    if (data.result == "success"){
                        $('#Deduct').text("-$"+price.toString())
                        $('#modal_page1').css("visibility", "visible");
                        $('.shop_header').css("opacity","0.5");
                        $('.nav').css("opacity","0.5");	
                        get_shop_page();
                    }
                    console.log(data.result)
                }
            });
            
        }

        function get_my_shop(){
            console.log('123')
            $.ajax({
              url: '/get_my_shop',
              method: 'POST',
              type: 'POST',
              dataType: "json",
              data: {
                  'account': window.location.href.split('?')[1].split('&')[0].split('=')[1],
              },
              success: function (data) {
                if (data.result == "success"){
                    // window.location.href = window.location.href;         
                    $('#owned_container').html("");
                    var pic_list = data.product_pic
                    for(var i = 0; i < pic_list.length; i++){
                        $.ajax({
                        url: '/get_img',
                        method: 'POST',
                        type: 'POST',
                        async: false, //改成同步執行(等待上一個回傳)
                        data: {
                            "img_path": pic_list[i],
                        },
                        success: function (img) {
                            console.log('123')
                            
                            $('#owned_container').append(
                                // "<img src=" + '"data:image/jpg;base64,'+img+'"> <br>' +
                                // data.product_name[i] + '<br>'+
                                // "商品ID: " + data.product_ID[i]+ '<br>'+
                                // "商品描述: " + data.product_detail[i]+ '<br>'+
                                // "商品剩餘: " + data.product_num[i]+ '<br>'          
                                
                                '<div class="owned_product" id="owned_p2">\
                                    <div class="owned_information">\
                                        <p class="product_name" id="owned_product2">'+ data.product_name[i] +'</p>\
                                        <p class="product_date" id="owned_date2">剩餘數量:'+ data.product_num[i] +'</p>\
                                    </div>\
                                    <button onclick=use('+ data.product_ID[i] +') type="button" class="btn_use" id="Use2"  >使用</button>\
                                </div>'
                            )
                        }
                        });
                    }
                    // $('#newpic').append('<button onclick=use('+ data.product_ID[i] +')>使用</button>')
                }
            }
        });
        }

        function use(product_ID){
            $.ajax({
                url: '/use_product',
                method: 'POST',
                type: 'POST',
                dataType: "json",
                data: {
                    'account': window.location.href.split('?')[1].split('&')[0].split('=')[1],
                    'product_ID': product_ID,
                },
                success: function (data) {
                    if (data.result == "success"){
                        $('#modal_page2').css("visibility", "visible");
                        $('.shop_header').css("opacity","0.5");
                        $('.nav').css("opacity","0.5");
                        get_my_shop();
                    }
                    console.log(data.result)
                }
            });
        };
        
        $('#modal_page1').click( function() {
            $('#modal_page1').css("visibility", "hidden");
            $('.shop_header').css("opacity","1");
            $('.nav').css("opacity","1");
        })

        $('#modal_page2').click( function() {
            $('#modal_page2').css("visibility", "hidden");
            $('.shop_header').css("opacity","1");
            $('.nav').css("opacity","1");
        })
    </script>
</html>